<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connect Stripe - Debug Mode</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #333; margin-bottom: 1rem; }
    input { width: 100%; padding: 1rem; margin: 1rem 0; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
    button {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #debugLog {
      background: #1e1e1e;
      color: #00ff00;
      padding: 1.5rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .error { color: #ff4444 !important; }
    .success { color: #00ff88 !important; }
    .info { color: #00d9ff !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Stripe Connect - Debug Mode</h1>
    <p>This page will show you exactly what's happening with the Stripe connection.</p>
    
    <input type="email" id="emailInput" placeholder="your.email@example.com">
    <button id="connectBtn">üîó Test Stripe Connection</button>
    <button id="clearBtn" style="background: #666;">Clear Log</button>
    
    <h3 style="margin-top: 2rem;">Debug Console:</h3>
    <div id="debugLog">Waiting for action...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAHMbxr7rJS88ZefVJzt8p_9CCTstLmLU8",
      authDomain: "yourspace-2026.firebaseapp.com",
      projectId: "yourspace-2026",
      storageBucket: "yourspace-2026.firebasestorage.app",
      messagingSenderId: "72667267302",
      appId: "1:72667267302:web:2bed5f543e05d49ca8fb27"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    const debugLog = document.getElementById('debugLog');
    const connectBtn = document.getElementById('connectBtn');
    const clearBtn = document.getElementById('clearBtn');
    const emailInput = document.getElementById('emailInput');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      debugLog.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(message);
    }
    
    clearBtn.onclick = () => {
      debugLog.innerHTML = 'Log cleared.\n';
    };
    
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        log('‚ùå ERROR: Not logged in. Redirecting to login...', 'error');
        setTimeout(() => {
          window.location.href = "login.html";
        }, 2000);
      } else {
        log(`‚úÖ Authenticated as: ${user.email}`, 'success');
        log(`üìù User ID: ${user.uid}`, 'info');
        emailInput.value = user.email;
      }
    });
    
    connectBtn.addEventListener('click', async () => {
      debugLog.innerHTML = '';
      log('üöÄ Starting Stripe connection process...', 'info');
      
      const email = emailInput.value.trim();
      
      if (!email || !email.includes("@")) {
        log('‚ùå Invalid email address', 'error');
        return;
      }
      
      if (!auth.currentUser) {
        log('‚ùå No user logged in', 'error');
        return;
      }
      
      connectBtn.disabled = true;
      log(`üìß Email: ${email}`, 'info');
      log(`üë§ User ID: ${auth.currentUser.uid}`, 'info');
      
      // Test 1: Check if function exists
      log('üîç TEST 1: Checking if Cloud Function exists...', 'info');
              const functionUrl = 'https://us-central1-yourspace-2026.cloudfunctions.net/createConnectAccount';
      log(`üìç Function URL: ${functionUrl}`, 'info');
      
      try {
        // First, try a simple OPTIONS request to see if function exists
        log('üì° Sending OPTIONS request...', 'info');
        const optionsResponse = await fetch(functionUrl, {
          method: 'OPTIONS',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        log(`üì• OPTIONS Response Status: ${optionsResponse.status}`, optionsResponse.ok ? 'success' : 'error');
        
        // Now send the actual POST request
        log('üì° Sending POST request with payload...', 'info');
        
        const payload = {
          userId: auth.currentUser.uid,
          email: email,
          refreshUrl: `${window.location.origin}/stripe-setup.html`,
          returnUrl: `${window.location.origin}/dashboard.html?stripe=complete`
        };
        
        log(`üì¶ Payload: ${JSON.stringify(payload, null, 2)}`, 'info');
        
        const response = await fetch(functionUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        log(`üì• Response Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        log(`üìã Response Headers:`, 'info');
        for (let [key, value] of response.headers.entries()) {
          log(`   ${key}: ${value}`, 'info');
        }
        
        // Get response text first to see raw response
        const responseText = await response.text();
        log(`üìÑ Raw Response Text:`, 'info');
        log(responseText, 'info');
        
        // Try to parse as JSON
        let data;
        try {
          data = JSON.parse(responseText);
          log(`‚úÖ Successfully parsed JSON response`, 'success');
          log(`üìä Parsed Data: ${JSON.stringify(data, null, 2)}`, 'info');
        } catch (parseError) {
          log(`‚ùå Failed to parse response as JSON: ${parseError.message}`, 'error');
          log(`üî¥ This means the Cloud Function returned invalid JSON or an error page`, 'error');
          connectBtn.disabled = false;
          return;
        }
        
        // Check response
        if (data.url) {
          log(`‚úÖ SUCCESS! Got Stripe URL`, 'success');
          log(`üîó Stripe URL: ${data.url}`, 'success');
          log(`üöÄ Redirecting in 3 seconds...`, 'success');
          
          setTimeout(() => {
            window.location.href = data.url;
          }, 3000);
        } else if (data.error) {
          log(`‚ùå ERROR from Cloud Function: ${data.error}`, 'error');
          log(`üîç Full error object: ${JSON.stringify(data, null, 2)}`, 'error');
          connectBtn.disabled = false;
        } else {
          log(`‚ùå Unexpected response structure`, 'error');
          log(`üìä Full response: ${JSON.stringify(data, null, 2)}`, 'error');
          connectBtn.disabled = false;
        }
        
      } catch (err) {
        log(`‚ùå FETCH ERROR: ${err.name}`, 'error');
        log(`üí¨ Error Message: ${err.message}`, 'error');
        log(`üìö Error Stack:`, 'error');
        log(err.stack, 'error');
        
        if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
          log(`üî¥ POSSIBLE CAUSES:`, 'error');
          log(`   1. Cloud Function not deployed yet`, 'error');
          log(`   2. CORS not configured properly`, 'error');
          log(`   3. Function URL is wrong`, 'error');
          log(`   4. Network/firewall blocking request`, 'error');
          log(`\nüí° TO FIX:`, 'info');
          log(`   1. Run: firebase deploy --only functions`, 'info');
          log(`   2. Check Firebase Console for function logs`, 'info');
          log(`   3. Verify function name matches exactly`, 'info');
        }
        
        connectBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
